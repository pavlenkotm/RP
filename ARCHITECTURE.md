# Архитектура программы

## Общая структура

Программа построена по модульному принципу с чёткой ответственностью каждого компонента.

```
┌─────────────────────────────────────────────────────────────┐
│                         main.py                              │
│              (Главный контроллер)                            │
└──────────────────┬──────────────────────────────────────────┘
                   │
                   ├──> ConfigManager (конфигурация)
                   │
                   ├──> RPLogger (логирование)
                   │
                   ├──> ExcelReader (чтение данных)
                   │
                   ├──> PDFParser (парсинг паспортов)
                   │
                   └──> DOCXGenerator (генерация документов)
```

## Модули

### 1. config_manager.py
**Ответственность:** Управление конфигурацией программы

**Основные методы:**
- `get_path(key)` - получение путей
- `get_mass_child()` - параметры нагрузок
- `get_category_texts(category)` - тексты по категориям

**Источники данных:**
- `config/config.json` - основные настройки
- `config/texts_by_category.json` - тексты для категорий

### 2. logger.py
**Ответственность:** Логирование работы программы

**Основные методы:**
- `log_start()` - начало работы
- `log_success()` - успешная обработка
- `log_error()` - ошибка обработки
- `log_summary()` - итоговая статистика

**Коды ошибок:**
- `ERR_NO_PASSPORT` - паспорт не найден
- `ERR_NO_IMAGE` - изображение не найдено
- `ERR_PDF_PARSE` - ошибка парсинга PDF
- `ERR_TEMPLATE` - ошибка работы с шаблоном
- `ERR_UNKNOWN` - неизвестная ошибка

### 3. excel_reader.py
**Ответственность:** Чтение данных из Excel каталога

**Основные методы:**
- `load_data()` - загрузка Excel
- `get_products()` - получение списка изделий

**Возвращаемая структура:**
```python
{
    'article': str,           # Артикул
    'name': str,              # Наименование
    'image_path': str,        # Путь к картинке
    'children_count': int,    # Количество детей
    'category': str,          # Категория изделия
    'row_index': int          # Индекс строки в Excel
}
```

**Определение категории:**
По ключевым словам в наименовании:
- "домик" → Домики
- "комплекс" → Игровые комплексы
- "песочниц" → Песочницы
- "беседк" → Беседки/Мини-беседки
- остальное → Игровые элементы

### 4. pdf_parser.py
**Ответственность:** Извлечение данных из PDF паспортов

**Основные методы:**
- `find_passport(article)` - поиск файла паспорта
- `extract_technical_data(pdf_path)` - извлечение таблицы данных

**Алгоритм:**
1. Поиск PDF по паттерну `*{артикул}*.pdf`
2. Открытие 2-й страницы паспорта
3. Извлечение таблицы "Основные технические данные"
4. Парсинг структуры: параметр → (значение, единица)
5. Исключение параметра "размер зоны приземления"

**Возвращаемая структура:**
```python
{
    'Высота': ('180', 'мм'),
    'Длина': ('390', 'мм'),
    'Ширина': ('200', 'мм'),
    ...
}
```

### 5. docx_generator.py
**Ответственность:** Генерация Word документов

**Основные методы:**
- `generate_document(product_data, technical_data)` - создание документа
- `_fill_document()` - заполнение данными
- `_insert_image()` - вставка изображения
- `_update_fields_com()` - обновление полей через COM

**Процесс генерации:**
1. Копирование шаблона
2. Открытие через python-docx
3. Замена плейсхолдеров в тексте
4. Вставка изображения
5. Сохранение документа
6. Обновление полей через Word COM

**Плейсхолдеры:**
- `{ARTICLE}` - артикул
- `{NAME}` - наименование
- `{REGION}` - регион
- `{CHILDREN_COUNT}` - количество детей
- `{TOTAL_MASS}` - общая масса детей
- `{SNOW_LOAD}` - снеговая нагрузка
- `{WIND_LOAD}` - ветровая нагрузка
- и другие динамические параметры

### 6. main.py
**Ответственность:** Координация работы всех модулей

**Основной алгоритм:**
```python
1. Инициализация компонентов
2. Загрузка списка изделий из Excel
3. Для каждого изделия:
   a. Поиск паспорта
   b. Извлечение технических данных
   c. Проверка изображения
   d. Генерация документа
   e. Логирование результата
4. Вывод итоговой статистики
```

## Потоки данных

### Входные данные
1. **Excel** → ExcelReader → список изделий
2. **PDF паспорта** → PDFParser → технические данные
3. **Изображения** → DOCXGenerator → вставка в документ
4. **Шаблон Word** → DOCXGenerator → базовая структура

### Выходные данные
1. **Word документы** → папка output_docs
2. **Лог-файл** → файл log_РП.txt

## Расширение функциональности

### Добавление новой категории
1. Обновить `config/texts_by_category.json`
2. Добавить логику определения в `excel_reader.py::_determine_category()`
3. Добавить категорию в `config.json::categories`

### Добавление нового плейсхолдера
1. Добавить в шаблон Word плейсхолдер вида `{НАЗВАНИЕ}`
2. В `docx_generator.py::_prepare_replacements()` добавить:
   ```python
   replacements['{НАЗВАНИЕ}'] = значение
   ```

### Изменение логики расчёта нагрузок
Параметры в `config.json`:
```json
{
  "loads": {
    "mass_child": 53.8,
    "snow_load": {"S0": 180},
    "wind_load": {"W0": 32}
  }
}
```

Использование в коде:
```python
mass_child = config.get_mass_child()
snow = config.get_snow_load()
```

## Обработка ошибок

### Философия
- Ошибка на одном изделии не останавливает обработку
- Все ошибки логируются с контекстом
- Итоговая статистика показывает общую картину

### Типы ошибок
1. **Критические** (останавливают программу):
   - Отсутствие конфигурации
   - Отсутствие Excel файла
   - Отсутствие шаблона

2. **Некритические** (пропускается изделие):
   - Отсутствие паспорта
   - Отсутствие изображения
   - Ошибка парсинга PDF
   - Ошибка генерации документа

## Производительность

### Узкие места
1. **Парсинг PDF** - ~0.5-1 сек на файл
2. **Генерация Word** - ~0.5-1 сек на документ
3. **Обновление полей через COM** - ~0.5-1 сек

### Оптимизация
- Используется копирование шаблона вместо создания с нуля
- PDF парсится только один раз для каждого изделия
- Изображения масштабируются автоматически

### Масштабирование
Текущая архитектура поддерживает:
- ✓ 300 изделий: ~10-15 минут
- ✓ 1000 изделий: ~30-45 минут

Для больших объёмов рекомендуется:
- Многопоточная обработка (ThreadPoolExecutor)
- Кэширование паспортов
- Пакетное обновление полей Word

## Зависимости

### Внешние библиотеки
- `pandas` - чтение Excel
- `openpyxl` - движок для Excel
- `python-docx` - работа с Word
- `pdfplumber` - парсинг PDF
- `pywin32` - COM для Word
- `Pillow` - работа с изображениями

### Системные требования
- Python 3.8+
- Windows 10/11
- Microsoft Word (для обновления полей)

## Тестирование

### Уровни тестирования
1. **Модульное** - test_single.py
   - Один продукт
   - Все компоненты
   - Быстрая проверка

2. **Интеграционное** - main.py
   - Полный цикл
   - Все изделия
   - Итоговая статистика

### Тестовые сценарии
- ✓ Изделие с полными данными
- ✓ Изделие без паспорта
- ✓ Изделие без изображения
- ✓ Изделие с некорректным PDF
- ✓ Разные категории изделий

## Развёртывание

### Автоматическое
```bash
deploy.bat
```

### Ручное
```bash
pip install -r requirements.txt
python test_single.py
python main.py
```

## Поддержка

### Диагностика проблем
1. Проверить лог-файл
2. Запустить test_single.py
3. Проверить конфигурацию
4. Проверить доступность файлов

### Частые проблемы
- Пути в конфигурации
- Кодировка имён файлов
- Права доступа к файлам
- Отсутствие Microsoft Word
